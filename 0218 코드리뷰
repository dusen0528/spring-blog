# 2/18

```java
  <!--TODO#1-1 Springê´€ë ¨ ì˜ì¡´ì„± ì¶”ê°€
              - spring-core - í•µì‹¬ì½”ì–´
              - spring-context - Application Context
              - spring-tx - íŠ¸ëœì­ì…˜ ì²˜ë¦¬
              - spring-jdbc - JdbcTemplate
              - spring-test - í…ŒìŠ¤íŠ¸
        -->
```

- Servlet ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìŠ¤í”„ë§ìœ¼ë¡œ êµ¬í˜„í•  ë•Œ ìµœì†Œí•œ í•„ìš”í•œ ì˜ì¡´ì„± 5ê°œ

```java
   <!-- @MockitoExtension ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ -->
        <dependency>
            <groupId>org.mockito</groupId>
            <artifactId>mockito-junit-jupiter</artifactId>
            <version>5.12.0</version>
            <scope>test</scope>
        </dependency>
```

- mockitoExtension í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©

ì˜ˆë¥¼ ì¶”ê°€í•´ë‘ë©´ Assertions ë“±ë„ ìë™ìœ¼ë¡œ ì¶”ê°€ë¨ í¬í•¨ë˜ì–´ ìˆê¸° ë•Œë¬¸

```java
/*
 * +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 * + Copyright 2024. NHN Academy Corp. All rights reserved.
 * + * While every precaution has been taken in the preparation of this resource,  assumes no
 * + responsibility for errors or omissions, or for damages resulting from the use of the information
 * + contained herein
 * + No part of this resource may be reproduced, stored in a retrieval system, or transmitted, in any
 * + form or by any means, electronic, mechanical, photocopying, recording, or otherwise, without the
 * + prior written permission.
 * +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 */

package com.nhnacademy.blog.common.context;

import com.nhnacademy.blog.common.config.ApplicationConfig;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.AnnotationConfigApplicationContext;

/**
 * ContextHolder í´ë˜ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”
 * Spring ApplicationContextë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
 *
 * - ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ëŠ” AnnotationConfigApplicationContextë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
 * - ApplicationConfig.classë¥¼ ì„¤ì •ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
 * - ì´ í´ë˜ìŠ¤ëŠ” ì¸ìŠ¤í„´ìŠ¤í™”(ê°ì²´ ìƒì„±)ë¥¼ í—ˆìš©í•˜ì§€ ì•Šìœ¼ë©°, ì „ì—­ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ì»¨í…ìŠ¤íŠ¸ë§Œ ì‚¬ìš©ë˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
 */
public class ContextHolder {

    /**
     * TODO#1-2 ApplicationContextë¥¼ ì •ì ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
     * - AnnotationConfigApplicationContextë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     * - ApplicationConfig.classë¥¼ ì„¤ì •ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
     * - ì´ˆê¸°í™” ì‹œì ì— í´ë˜ìŠ¤ê°€ ë¡œë“œë  ë•Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.
     */
    private static final ApplicationContext context = new AnnotationConfigApplicationContext(ApplicationConfig.class);

    /**
     * ContextHolder í´ë˜ìŠ¤ì˜ ê¸°ë³¸ ìƒì„±ì.
     * - ì´ í´ë˜ìŠ¤ëŠ” ì¸ìŠ¤í„´ìŠ¤í™”ê°€ ê¸ˆì§€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
     * - new ContextHolder()ë¥¼ í˜¸ì¶œí•˜ë ¤ê³  í•˜ë©´ IllegalStateException ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.
     */
    private ContextHolder() {
        throw new IllegalStateException("ContextHolder should not be instantiated");
    }

    /**
     * ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     * - ë™ê¸°í™”ë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     *
     * @return ApplicationContext ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ ì»¨í…ìŠ¤íŠ¸
     */
    public static synchronized ApplicationContext getApplicationContext() {
        return context;
    }
}

```

- BEAN : ì¬ì‚¬ìš© ê°€ëŠ¥í•œ JAVA ê°ì²´
- ê°ì²´ë“¤ì„ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡ í›„ í•„ìš”í•  ë•Œ ë§ˆë‹¤ ê°€ì ¸ë‹¤ ì“°ëŠ” í™˜ê²½
- ìŠ¤í”„ë§ì—ì„œ ApplicationContext êµ¬í˜„ì²´ê°€ ì—¬ëŸ¬ê°€ì§€ê°€ ìˆëŠ”ë° ê¸°ë³¸ì ìœ¼ë¡œ AnnotationConfigApplicationContext í´ë˜ìŠ¤ ì‚¬ìš©

```java
    private static final ApplicationContext context = new AnnotationConfigApplicationContext();

```

- ì´ ê°ì²´ë¥¼ ìƒì„±í•˜ìë§ˆì
- ì»´í¬ë„ŒíŠ¸ ì–´ë…¸í…Œì´ì…˜ í¬í•¨ì¤‘ì¸ @Repository, @Service ë“±ì„ ìŠ¤ìº”
- ë‹¨ ì–´ë–¤ ê¸°ì¤€ì¸ì§€ ëª¨ë¥´ê¸°ì— íŒŒë¼ë¯¸í„°ë¡œ ApplicationConfig.class
    - ì–´ë…¸í…Œì´ì…˜ ê¸°ë°˜ í™˜ê²½ ì„¤ì •ì„ í•˜ê² ë‹¤ëŠ” ì˜ë¯¸

```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by FernFlower decompiler)
//

package org.springframework.context;

import org.springframework.beans.factory.HierarchicalBeanFactory;
import org.springframework.beans.factory.ListableBeanFactory;
import org.springframework.beans.factory.config.AutowireCapableBeanFactory;
import org.springframework.core.env.EnvironmentCapable;
import org.springframework.core.io.support.ResourcePatternResolver;
import org.springframework.lang.Nullable;

public interface ApplicationContext extends EnvironmentCapable, ListableBeanFactory, HierarchicalBeanFactory, MessageSource, ApplicationEventPublisher, ResourcePatternResolver {
    @Nullable
    String getId();

    String getApplicationName();

    String getDisplayName();

    long getStartupDate();

    @Nullable
    ApplicationContext getParent();

    AutowireCapableBeanFactory getAutowireCapableBeanFactory() throws IllegalStateException;
}
```

`*íŠ¹ì • ì• ë…¸í…Œì´ì…˜(@Component, @Service, @Repository, @Controller*`

ë“±ì„ ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡í•´ì„œ ë¹ˆìœ¼ë¡œ ì €ì¥

```java
package com.nhnacademy.blog;

/**
 * TODO#1-4 Root Package Marker interface
 *
 * ë§ˆì»¤ ì¸í„°í˜ì´ìŠ¤ëŠ” ë©”ì†Œë“œë‚˜ ìƒìˆ˜ê°€ ì—†ëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
 * ì´ ì¸í„°í˜ì´ìŠ¤ëŠ” í´ë˜ìŠ¤ê°€ íŠ¹ì • ì†ì„±ì´ë‚˜ í–‰ë™ì„ ê°€ì§€ê³  ìˆìŒì„ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ì´ ê²½ìš°, `RootPackageBase` ì¸í„°í˜ì´ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë£¨íŠ¸ íŒ¨í‚¤ì§€ì— ì†í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•œ ë§ˆì»¤ ì—­í• ì„ í•©ë‹ˆë‹¤.
 * ë§ˆì»¤ ì¸í„°í˜ì´ìŠ¤ëŠ” ì£¼ë¡œ ë©”íƒ€ë°ì´í„°ë¥¼ ì œê³µí•˜ê±°ë‚˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íŠ¹ì • ë¶€ë¶„ì—ì„œ íŠ¹ë³„í•œ ì²˜ë¦¬ë¥¼ ì ìš©í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 */
public interface RootPackageBase {
}

```

```java

@ComponentScan(basePackageClasses = RootPackageBase.class)

public class ApplicationConfig {
}

```

- RootPackageBase ì¸í„°í˜ì´ìŠ¤ê°€ êµ¬í˜„ë˜ì–´ìˆëŠ” ê²½ë¡œë¶€í„° ìŠ¤ìº”
- RootPackageBaseê°€ ì—†ë‹¤ë©´

```java

//@ComponentScan(basePackageClasses = RootPackageBase.class)
@ComponentScan(basePackages = {"com.nhnacademy.blog"})
```

- ì´ì™€ê°™ì´ ì‘ì„±í•´ë„ ë™ì¼í•˜ê²Œ ë™ì‘

<aside>
ğŸ’¡

**ë‘ê°€ì§€ ë°©ì‹ì˜  ì°¨ì´ì ì€?**

ì €ë ‡ê²Œ í…ìŠ¤íŠ¸ë¡œ í•˜ë©´ ì˜¤íƒ€ê°€ ë‚  ìˆ˜ ìˆë‹¤ . . .

ê·¸ë˜ì„œ í´ë˜ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ëª…í™•íˆ ì§€ì •í•´ì¤Œ

</aside>

RootBasePackage ì²˜ëŸ¼ ì•„ë¬´ ê¸°ëŠ¥ë„ ì—†ì´ ëª…ì‹œì ìœ¼ë¡œ ì„ ì–¸ë§Œ í•œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§ˆì»¤ì¸í„°í˜ì´ìŠ¤ë¼ê³  í•¨

## DataSourceConfig

```java
package com.nhnacademy.blog.common.config;

import com.nhnacademy.blog.common.db.DbProperties;
import com.p6spy.engine.spy.P6DataSource;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.dbcp2.BasicDataSource;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;

import javax.sql.DataSource;
import java.sql.Connection;
import java.time.Duration;

import org.apache.commons.dbcp2.BasicDataSource;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import javax.sql.DataSource;
import java.sql.Connection;
import java.time.Duration;

/**
 * TODO#1-5 DataSource Bean ìƒì„±
 *
 * ì´ í´ë˜ìŠ¤ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— í•„ìš”í•œ DataSourceë¥¼ ì„¤ì •í•˜ëŠ” í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
 * Springì˜ @Configuration ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ Spring IoC ì»¨í…Œì´ë„ˆì— ì„¤ì • ì •ë³´ë¥¼ ì œê³µí•˜ë©°,
 * @Bean ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ DataSource ë¹ˆì„ ìƒì„±í•˜ê³  ì´ë¥¼ Spring ì»¨í…Œì´ë„ˆì— ë“±ë¡í•©ë‹ˆë‹¤.
 *
 * @Configuration:
 * - ì´ ì–´ë…¸í…Œì´ì…˜ì€ í•´ë‹¹ í´ë˜ìŠ¤ê°€ "ì„¤ì • í´ë˜ìŠ¤"ì„ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
 * - ì„¤ì • í´ë˜ìŠ¤ëŠ” Spring IoC ì»¨í…Œì´ë„ˆì— ë¹ˆì„ ì •ì˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
 * - ì´ ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ í´ë˜ìŠ¤ëŠ” Spring ì»¨í…Œì´ë„ˆì— ì˜í•´ ìë™ìœ¼ë¡œ ê´€ë¦¬ë˜ë©°,
 *   ì´ í´ë˜ìŠ¤ ë‚´ë¶€ì—ì„œ ì •ì˜ëœ @Bean ë©”ì†Œë“œë“¤ì€ Spring ì»¨í…Œì´ë„ˆì— ë¹ˆìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.
 * - @Configurationì„ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ í´ë˜ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì„¤ì •ì„ í¬í•¨í•˜ëŠ” ì—­í• ì„ í•˜ë©°,
 *   ë‹¤ë¥¸ í´ë˜ìŠ¤ì—ì„œ í•„ìš”í•œ ë¹ˆì„ ìƒì„±í•˜ê±°ë‚˜, ì„¤ì • ê°’ì„ ì£¼ì…í•˜ëŠ” ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 *
 * ì˜ˆë¥¼ ë“¤ì–´, @Configurationì„ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •ì„ í¬í•¨í•œ DataSource ë¹ˆì„ ì •ì˜í•˜ê±°ë‚˜,
 * ì„œë¹„ìŠ¤, ë ˆí¬ì§€í† ë¦¬, ì—”í‹°í‹° ë“±ì˜ ë‹¤ë¥¸ ë¹ˆë“¤ì„ ì„¤ì •í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 */

@Slf4j
@Configuration
public class DataSourceConfig {

    /**
     * @Bean ì–´ë…¸í…Œì´ì…˜ì€ í•´ë‹¹ ë©”ì†Œë“œê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´ë¥¼ Springì˜ ë¹ˆ(Bean)ìœ¼ë¡œ ë“±ë¡í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
     * ì´ ë©”ì†Œë“œì—ì„œëŠ” DataSourceë¥¼ ìƒì„±í•˜ê³ , í•„ìš”í•œ ì„¤ì •ì„ ì ìš©í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
     * DataSourceëŠ” ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ì—°ê²°ì„ ê´€ë¦¬í•˜ëŠ” ê°ì²´ë¡œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ DBì— ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
     *
     * @param dbProperties ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ì†ì„±ê°’ì„ ë‹´ê³  ìˆëŠ” DbProperties ê°ì²´
     *                    ì´ ê°ì²´ëŠ” Springì—ì„œ ìë™ìœ¼ë¡œ ì£¼ì…ë©ë‹ˆë‹¤.
     *                    DbPropertiesê°€ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ë³„ë„ë¡œ ì„¤ì •í•˜ì§€ ì•Šì•„ë„
     *                    ìë™ìœ¼ë¡œ Spring ì»¨í…Œì´ë„ˆê°€ ì£¼ì…í•©ë‹ˆë‹¤.
     *                    DbProperties í´ë˜ìŠ¤ì—ëŠ” @ConfigurationProperties ë˜ëŠ” @Component ë“±ì˜ ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ ìˆì–´
     *                    Spring IoC ì»¨í…Œì´ë„ˆì— ì˜í•´ ê´€ë¦¬ë˜ë©°, DataSourceConfigì—ì„œ ìë™ìœ¼ë¡œ ì£¼ì…ë©ë‹ˆë‹¤.
     * @return ì„¤ì •ëœ DataSource ê°ì²´
     */
    @Bean("dataSource")
    public DataSource dataSource(DbProperties dbProperties){
        log.debug("datasource-dbProperties: {}", dbProperties);

        // ê¸°ë³¸ì ì¸ ë°ì´í„°ì†ŒìŠ¤ ì„¤ì •
        BasicDataSource basicDataSource = new BasicDataSource();
        basicDataSource.setUrl(dbProperties.getUrl());
        basicDataSource.setUsername(dbProperties.getUsername());
        basicDataSource.setPassword(dbProperties.getPassword());

        basicDataSource.setInitialSize(dbProperties.getInitialSize());
        basicDataSource.setMaxTotal(dbProperties.getMaxTotal());
        basicDataSource.setMaxIdle(dbProperties.getMaxIdle());
        basicDataSource.setMinIdle(dbProperties.getMinIdle());

        basicDataSource.setMaxWait(Duration.ofSeconds(dbProperties.getMaxWait()));
        basicDataSource.setValidationQuery(dbProperties.getValidationQuery());
        basicDataSource.setTestOnBorrow(dbProperties.isTestOnBorrow());
        basicDataSource.setDefaultTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);

        // Spy ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€ì— ë”°ë¼ P6Spy ë°ì´í„°ì†ŒìŠ¤ ì ìš©
        return dbProperties.isSpy() ? createP6SpyDataSource(basicDataSource) : basicDataSource;
    }

    /**
     * P6Spyë¥¼ ì‚¬ìš©í•˜ì—¬ SQL ì¿¼ë¦¬ ë¡œê·¸ë¥¼ ê¸°ë¡í•  ìˆ˜ ìˆëŠ” DataSourceë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     * @param dataSource ê¸°ì¡´ì˜ DataSource
     * @return P6Spyë¥¼ ì ìš©í•œ DataSource
     */
    private DataSource createP6SpyDataSource(DataSource dataSource){
        return new P6DataSource(dataSource);
    }

}

```

- Connection Pool ì—­í• 

**@Configuration** 

- @Component ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆê¸° ë•Œë¬¸ì— ìŠ¤ìº”ì„ í†µí•´ ë¹ˆìœ¼ë¡œ ì €ì¥í•˜ëŠ” ê°ì²´
- ì´ê±¸ ë¹¼ê³  ê·¸ëƒ¥ @Component ì¨ë„ ë˜ëŠ”ë° ì°¨ì´ì ì´ ì¡´ì¬
- í´ë˜ìŠ¤ì— ë°”ë¡œ ì»´í¬ë„ŒíŠ¸ë¥¼ ë¶™ì—¬ì£¼ë©´ DataSourceConfig ìì²´ê°€ BEANì´ ë˜ì–´ë²„ë¦¼
- í•˜ì§€ë§Œ ë°‘ì— @Bean ì„ ë‹¬ì•„ë†“ëŠ” ë©”ì†Œë“œê°€ ìˆë‹¤ë©´?
- í•´ë‹¹ ë©”ì†Œë“œ í˜¸ì¶œ í›„ ì‘ë‹µë˜ëŠ” ê°ì²´ê°€ BEANì´ ëœë‹¤
- ì¦‰ í´ë˜ìŠ¤ ìì²´ë¥¼ ë¹ˆìœ¼ë¡œ ë§Œë“œëŠ” ê²ƒì´ ì•„ë‹Œ ë©”ì†Œë“œì—ì„œ ë¦¬í„´í•´ì£¼ëŠ” ê°’ì„ ë¹ˆìœ¼ë¡œ ë§Œë“¤ê² ë‹¤ëŠ” ëª©ì ì´ @Bean ì–´ë…¸í…Œì´ì…˜ì„ ê°€ì§€ê³  ìˆëŠ” ë©”ì†Œë“œ
    - DBCP2ë¥¼ ë¹ˆìœ¼ë¡œ ë§Œë“¤ê² ë‹¤
- DbProperties í´ë˜ìŠ¤ë¡œ ë“¤ì–´ê°€ë³´ë©´ @PropertySource(â€classpath:db.propertiesâ€) ì´ íŒŒì¼ì„ ì½ì–´ì£¼ëŠ” ì—­í• ì„ í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤

```java

    @Value("${db.url}")
    private String url; // ë°ì´í„°ë² ì´ìŠ¤ URL
    @Value("${db.username}")
    private String username; // ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ìëª…
    @Value("${db.password}")
    private String password; // ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸
```

ì–´ë…¸í…Œì´ì…˜ í´ë¦­í•´ë³´ë©´ í•´ë‹¹ íŒŒì¼ì˜ í•´ë‹¹ ê°’ìœ¼ë¡œ ì´ë™í•œë‹¤

ì›ë˜ë¼ë©´ íŒŒì¼ì„ InputìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì½ê³  í”„ë¡œí¼í‹° ê°ì²´ë¡œ ë§Œë“¤ì–´ ë¹ˆìœ¼ë¡œ ë“±ë¡í–ˆì§€ë§Œ, @value ì–´ë…¸í…Œì´ì…˜ì„ ì´ìš©í•´ì„œ ì‰½ê²Œ ëë‚¬ìŒ

ì¦‰ @PropertySource ì–´ë…¸í…Œì´ì…˜ì„ ì“°ë©´ íŒŒë¼ë¯¸í„° ê²½ë¡œì— ìˆëŠ íŒŒì¼ì„ ì½ì–´ë²„ë¦¬ê³  @Valueë¥¼ í†µí•´ì„œ ê°’ì„ í• ë‹¹

@Configurationì€ @Component ì–´ë…¸í…Œì´ì…˜ì´ ìˆê¸°ì— ë¹ˆìœ¼ë¡œ ë§Œë“¤ì–´ì§

DbPropertiesëŠ” í™˜ê²½ì„¤ì •ì´ê¸° ë•Œë¬¸ì— @Componentë„ ë˜ì§€ë§Œ @Configurationìœ¼ë¡œ ì¨ì£¼ëŠ” ê±°ì„

ì¦‰ ì´ ì‹œì ì— ë¹ˆì— ë“±ë¡ë˜ì–´ ìˆëŠ”ë°..

DataSourceConfig íŒŒì¼ë¡œ ë‹¤ì‹œ ë„˜ì–´ì™€ì„œ

```java
@Bean("dataSource")
    public DataSource dataSource(DbProperties dbProperties){
        log.debug("datasource-dbProperties: {}", dbProperties);

        // ê¸°ë³¸ì ì¸ ë°ì´í„°ì†ŒìŠ¤ ì„¤ì •
        BasicDataSource basicDataSource = new BasicDataSource();
        basicDataSource.setUrl(dbProperties.getUrl());
        basicDataSource.setUsername(dbProperties.getUsername());
        basicDataSource.setPassword(dbProperties.getPassword());

        basicDataSource.setInitialSize(dbProperties.getInitialSize());
        basicDataSource.setMaxTotal(dbProperties.getMaxTotal());
        basicDataSource.setMaxIdle(dbProperties.getMaxIdle());
        basicDataSource.setMinIdle(dbProperties.getMinIdle());

        basicDataSource.setMaxWait(Duration.ofSeconds(dbProperties.getMaxWait()));
        basicDataSource.setValidationQuery(dbProperties.getValidationQuery());
        basicDataSource.setTestOnBorrow(dbProperties.isTestOnBorrow());
        basicDataSource.setDefaultTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);

        // Spy ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€ì— ë”°ë¼ P6Spy ë°ì´í„°ì†ŒìŠ¤ ì ìš©
        return dbProperties.isSpy() ? createP6SpyDataSource(basicDataSource) : basicDataSource;
    }

```

1. ìŠ¤í”„ë§ì€ ë¨¼ì € ë¹ˆì„ ë§Œë“¤ ë•Œ Dbpropertiesë¥¼ ì•Œì•„ì„œ ë¹ˆì— ë“±ë¡í•´ì¤€ë‹¤ (ìŠ¤í”„ë§ ë¹ˆë“¤ê°„ ì˜ì¡´ê´€ê³„ë¥¼ ê³ ë ¤í•´ì„œ ìƒì„±)
    - í”„ë ˆì„ì›Œí¬ë§Œë“¤ë•ŒëŠ” @Component â†’ @Repository â†’ @Serviceë¥¼ ìˆœì„œ ì§ì ‘ ì •í•´ì¤¬ìŒ
2. ì¦‰ í™˜ê²½ ì„¤ì • ì–´ë…¸í…Œì´ì…˜ë§Œ ì˜ ë¶™ì—¬ì£¼ë©´ ê°œë°œìê°€ ì‹ ê²½ì“¸ í•„ìš”ì—†ì´ ì•Œì•„ì„œ ì¨ì¤Œ

```java
@Configuration
public class DataSourceConfig {

```

- ì´ë ‡ê²Œ @Configurationì´ ë¶™ì–´ìˆì–´ì•¼ì§€ ë©”ì†Œë“œë§Œ BEANìœ¼ë¡œ ë“±ë¡ì´ ê°€ëŠ¥

> ê²°ë¡  @Configuration íƒœê·¸ë¥¼ ë¶™ì—¬ì„œ ë©”ì†Œë“œ ë ˆë²¨ì˜ ë¹ˆì„ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆë‹¤. í™˜ê²½ì„¤ì •ì‹œ ë¶™ì—¬ì£¼ê¸°
> 

---

## TODO 1-8 Transacation

ì˜¤ë¥˜ ë°œìƒì‹œ rollback

sql ì˜¤ë¥˜ ì—†ìœ¼ë©´ ì»¤ë°‹ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬í–ˆë‹¤

ì¦‰ ì ì ˆí•œ ì‹œì ì„ ê°œë°œìê°€ ì§ì ‘í•´ì¤¬ì—ˆë”°ë©´

```java
package com.nhnacademy.blog.common.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import javax.sql.DataSource;

/**
 * TODO#1-8 Transaction ê´€ë¦¬
 *
 * ì´ í´ë˜ìŠ¤ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
 * @Configuration: í•´ë‹¹ í´ë˜ìŠ¤ê°€ ìŠ¤í”„ë§ì˜ ì„¤ì • í´ë˜ìŠ¤ì„ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
 * @EnableTransactionManagement: íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¥¼ í™œì„±í™”í•˜ê³ , íŠ¸ëœì­ì…˜ ê´€ë ¨ ì–´ë…¸í…Œì´ì…˜(@Transactional)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
 * íŠ¸ëœì­ì…˜ ê´€ë¦¬ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì˜ ì¼ê´€ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ í•„ìš”í•˜ë©°, ë°ì´í„°ë² ì´ìŠ¤ ì—°ì‚° ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ ë¡¤ë°±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.
 */
@Configuration
@EnableTransactionManagement // íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜
public class TransactionConfig {

    /**
     * íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì„¤ì •í•˜ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤.
     * DataSourceë¥¼ ì‚¬ìš©í•˜ì—¬ DataSourceTransactionManagerë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
     * DataSourceTransactionManagerëŠ” JDBC ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ëŠ” êµ¬í˜„ì²´ì…ë‹ˆë‹¤.
     * @param dataSource ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” DataSource ê°ì²´
     * @return PlatformTransactionManager ê°ì²´
     *
     * PlatformTransactionManagerëŠ” ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ë¡œ,
     * ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € êµ¬í˜„ì²´ê°€ ì´ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬ ì‚¬ìš©ë©ë‹ˆë‹¤.
     * DataSourceTransactionManagerëŠ” JDBC íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©í•˜ëŠ” êµ¬í˜„ì²´ì…ë‹ˆë‹¤.
     *
     * íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” íŠ¸ëœì­ì…˜ì„ ì‹œì‘, ì»¤ë°‹, ë¡¤ë°±í•˜ëŠ” ì±…ì„ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
     * ì¦‰, ë°ì´í„°ë² ì´ìŠ¤ì˜ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ì—¬, ì—¬ëŸ¬ ê°œì˜ ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ê³ ,
     * ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ì»¤ë°‹í•˜ê³ , ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ë¡¤ë°±í•˜ì—¬ ë°ì´í„°ì˜ ì¼ê´€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.
     */
    @Bean
    PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource); // DataSourceë¥¼ ì‚¬ìš©í•œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
    }

    /**
     * JdbcTemplateì„ ì„¤ì •í•˜ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤.
     * JdbcTemplateì€ SQL ì¿¼ë¦¬ ì‹¤í–‰ì„ ê°„ì†Œí™”í•´ ì£¼ëŠ” Springì˜ ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
     * SQL ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë³µì¡í•œ ì‘ì—…ì„ ëŒ€ì‹  ì²˜ë¦¬í•´ ì¤ë‹ˆë‹¤.
     * @param dataSource ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” DataSource ê°ì²´
     * @return JdbcTemplate ê°ì²´
     *
     * JdbcTemplateì˜ ì£¼ìš” ê¸°ëŠ¥:
     * 1. SQL ì¿¼ë¦¬ ì‹¤í–‰: SQL ì¿¼ë¦¬, ì—…ë°ì´íŠ¸ ë˜ëŠ” ì¡°íšŒë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     * 2. ê²°ê³¼ ë§¤í•‘: ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ê°ì²´ë¡œ ë§¤í•‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ResultSetì„ íŠ¹ì • ê°ì²´ì— ë§¤í•‘í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
     * 3. ì˜ˆì™¸ ì²˜ë¦¬: SQLExceptionê³¼ ê°™ì€ JDBC ì˜ˆì™¸ë¥¼ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ë³€í™˜í•˜ì—¬ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     * 4. ë¦¬ì†ŒìŠ¤ ê´€ë¦¬: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, Statement, ResultSet ë“± ë¦¬ì†ŒìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ì¢…ë£Œì‹œì¼œ ì¤ë‹ˆë‹¤.
     * 5. Batch ì²˜ë¦¬: ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ë•Œ ìœ ìš©í•œ ë°°ì¹˜ ì²˜ë¦¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.
     *
     * JdbcTemplateì€ ë°˜ë³µì ì¸ JDBC ì½”ë“œë¥¼ ê°„ì†Œí™”í•˜ê³ , ìì› ê´€ë¦¬ ë° ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìë™í™”í•˜ì—¬ ê°œë°œìê°€ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.
     */
    @Bean
    JdbcTemplate jdbcTemplate(DataSource dataSource) {
        return new JdbcTemplate(dataSource); // DataSourceë¥¼ ì‚¬ìš©í•˜ì—¬ JdbcTemplate ê°ì²´ ìƒì„±
    }
}

```

- ì´ê±¸ í†µí•´ì„œ Configuration ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì—¬ì£¼ê³  íŠ¸ëœì­ì…˜ ì„¤ì •í•œë‹¤ëŠ” ê±¸ ëª…ì‹œ
- @EnableTransactionManagementë¥¼ í†µí•´ì„œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê² ë‹¤ê³  ëª…ì‹œ
- ê°œë°œìê°€ íŠ¸ëœì­ì…˜ ì‹œì ì„ íŒë‹¨í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ìŠ¤í”„ë§ì´ ì§ì ‘ íŒë‹¨í•˜ê²Œë¨

`*PlatformTransactionManagerëŠ” getTransaction, commit, rollback 3ê°œì˜ ë©”ì†Œë“œë¡œ ì •ì˜ë˜ì–´ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤`* 

```java
    @Bean
    PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource); // DataSourceë¥¼ ì‚¬ìš©í•œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
    }
```

- Bean(name=â€transactionManagerâ€) ì´ë ‡ê²Œ ëª…ì‹œí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë©”ì†Œë“œëª…ìœ¼ë¡œ ë¹ˆ ì´ë¦„ì´ ìƒì„±ë¨
- ì—¬ê¸°ì„œ ë¦¬í„´ë˜ëŠ” ê°’ì´ DataSourceTransactionManagerë¼ëŠ” ê°’ì´ ë¦¬í„´ë˜ì–´ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ëŠ”ë°

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„Œá…¥á†« 10.48.04.png](attachment:35439bf8-db0b-4e16-ba3b-a9b44df0eb43:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„Œá…¥á†«_10.48.04.png)

PlatformTansactionManger êµ¬í˜„ì²´ì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤

Datasource ìì²´ê°€ ì»¤ë„¥ì…˜ í’€ì¸ë° ì´ê±¸ ì£¼ì… ë°›ìŒ

JDBCëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì»¤ë„¥ì…˜ì„ í•˜ë‚˜ ì–»ì–´ì™€ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ”ë° DataSourceTranscationManagerë¥¼ ìƒì„±í•˜ëŠ”ë°.. ì´ê±¸ ë¹ˆìœ¼ë¡œ ë§Œë“¤ì–´ ë“±ë¡í•´ì£¼ë©´ 

```java
@EnableTransactionManagement // íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜
```

ì´ê²Œ í™œì„±í™”ë¨

JPAë¼ëŠ” ê¸°ìˆ ì€ Datasourceë¥¼ ì§ì ‘ì ìœ¼ë¡œ ì“°ëŠ”ê²Œ ì•„ë‹Œ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©

ì–œ jpaTransactionManagerë¥¼ ì”€

í•˜ì§€ë§Œ ì–´ë–¤ ê¸°ìˆ ì„ ì“°ë˜ì§€ @Transaction ì–´ë…¸í…Œì´ì…˜ë§Œ ë¶™ì—¬ì£¼ë©´ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ê°€ ëœë‹¤ 

íŠ¸ëœì­ì…˜ êµ¬í˜„ì²´ ! !

ì´ëŸ°ê±°ë¥¼ PortableServiceAbstraction ë¼ê³  í•˜ëŠ”ë° ì´ê²Œ ìŠ¤í”„ë§ ì½”ì–´ì˜ í•µì‹¬ ê¸°ëŠ¥

ìŠ¤í”„ë§ì´ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— JPAë¥¼ ìŒ©ìœ¼ë¡œ ì“°ëŠ”ê²Œ ì•„ë‹Œ íŠ¸ëœì­ì…˜ ë‹¬ì•„ì¤˜ì•¼í•¨

ê·¸ê²Œ ë°”ë¡œ jdbcTemplateë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì£¼ë©´ ì–˜ë¥¼ í†µí•´ì„œ jdbc apië¥¼ ì¨ì•¼ ìŠ¤í”„ë§ì´ ê´€ë¦¬í•˜ë„ë¡ ìœ„ì„í•´ì¤„ ìˆ˜ ìˆë‹¤ 

```java
@Repository
public class JdbcMemberRepository implements MemberRepository {

    private final JdbcTemplate jdbcTemplate;
```

ì–˜ë„ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì„ í†µí•´ ë¹ˆìœ¼ë¡œ ë“±ë¡ëœë‹¤

```java
/**
 * @ComponentScan:
 * - ì§€ì •ëœ RootPackageBase.classë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ìœ„ íŒ¨í‚¤ì§€ì—ì„œ Springì˜ íŠ¹ì • ì• ë…¸í…Œì´ì…˜(@Component, @Service, @Repository, @Controller)ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.
 * - basePackageClasses ì†ì„±ì„ í†µí•´ íŠ¹ì • í´ë˜ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê¸°ë³¸ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
 * - ì—¬ê¸°ì„œëŠ” RootPackageBaseë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìŠ¤ìº” ë²”ìœ„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
 *
 * @Component: Springì»¨í…Œì´ë„ˆê°€ ê´€ë¦¬í•˜ëŠ” ì¼ë°˜ì ì¸ BEANê°ì²´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
 * êµ¬ì²´ì ì¸ ì—­í• ì— ë”°ë¼ Service, Repository, Controllerë¡œ ì„¸ë¶„í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 * 
 * @Service:
 * - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * - ì„œë¹„ìŠ¤ ê³„ì¸µì— ëª…í™•í•œ ì—­í• ì„ ë¶€ì—¬í•˜ë©°, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ í¬í•¨ëœ í´ë˜ìŠ¤ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
 *
 * @Repository:
 * - ë°ì´í„° ì•¡ì„¸ìŠ¤ ê³„ì¸µì—ì„œ ì‚¬ìš©ë˜ë©°, ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ìƒí˜¸ì‘ìš©ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
 * - ì£¼ë¡œ DAO(Data Access Object) í´ë˜ìŠ¤ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
 * - @RepositoryëŠ” ë°ì´í„° ì•¡ì„¸ìŠ¤ ì˜ˆì™¸ë¥¼ Spring ë°ì´í„° ì•¡ì„¸ìŠ¤ ì˜ˆì™¸ë¡œ ë³€í™˜í•˜ëŠ” ì—­í• ë„ í•©ë‹ˆë‹¤.
 *
 *
 * @Controller:
 * - í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µì—ì„œ ì‚¬ìš©ë˜ë©°, ì›¹ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³  ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
 * - ì£¼ë¡œ HTTP ìš”ì²­ì„ ë§¤í•‘í•˜ê³ , ì ì ˆí•œ ë·°(View)ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
```

ì´ëŸ° ì• ë“¤ì„ ìŠ¤í…Œë ˆì˜¤ íƒ€ì… ë¹ˆ, ìŠ¤í…Œë ˆì˜¤ ë¹ˆ ë“±ì´ë¼ê³  ì¹­í•¨

```java
public class JdbcMemberRepository implements MemberRepository {

    private final JdbcTemplate jdbcTemplate;

    // ìƒì„±ì ì£¼ì… ë°©ì‹ìœ¼ë¡œ JdbcTemplateì„ ì£¼ì…ë°›ìŠµë‹ˆë‹¤. ìƒì„±ì ì£¼ì…ì€ í•„ë“œ ì£¼ì…ì´ë‚˜ ì„¸í„° ì£¼ì…ë³´ë‹¤ ë” ì•ˆì „í•˜ë©° í…ŒìŠ¤íŠ¸ê°€ ìš©ì´í•©ë‹ˆë‹¤.
    // í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•  ë•Œ í•´ë‹¹ ê°ì²´ë¥¼ Mockingí•˜ê¸° ì‰½ê³ , ê°ì²´ê°€ ë¶ˆë³€ì„±ì„ ê°€ì§ˆ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê¶Œì¥ë˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
    public JdbcMemberRepository(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

```

- ìƒì„±ìì£¼ì…
    - ì–´ë”˜ê°€ì—ì„œ ë¹ˆì— ë“±ë¡ë˜ì–´ìˆëŠ” JdbcTemplate
        - TransacationConfigì— ìˆìŒ
    - ì¦‰ TransactionConfigì— @Bean íƒœê·¸ê°€ ë¶™ì–´ìˆëŠ” JdbcTemplate ì˜ˆë¥¼ ìˆœì„œì— ë§ê²Œ ìŠ¤í”„ë§ì´ ì•Œì•„ì„œ ë“±ë¡í•´ì¤€ë‹¤

```java
 @Override
    public void save(Member member) {
        // íšŒì› ì •ë³´ë¥¼ members í…Œì´ë¸”ì— ì‚½ì…í•˜ëŠ” SQL ì¿¼ë¦¬ë¬¸
        String sql = """
                    insert into members (
                        mb_email,
                        mb_name,
                        mb_password,
                        mb_mobile,
                        created_at
                    ) 
                    values(?,?,?,?,?);
                """;

        // KeyHolderëŠ” ì‚½ì…ëœ ë ˆì½”ë“œì˜ í‚¤ ê°’ì„ ë°˜í™˜ë°›ê¸° ìœ„í•œ ê°ì²´
        KeyHolder keyHolder = new GeneratedKeyHolder();

        // JdbcTemplateì˜ update ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ PreparedStatementë¥¼ ìƒì„±í•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
        // PreparedStatement ê°ì²´ë¥¼ í†µí•´ SQL ì¿¼ë¦¬ì˜ íŒŒë¼ë¯¸í„°ë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
        int rows = jdbcTemplate.update(connection -> {
            PreparedStatement psmt = connection.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
            int index = 1;
            psmt.setString(index++, member.getMbEmail());
            psmt.setString(index++, member.getMbName());
            psmt.setString(index++, member.getMbPassword());
            psmt.setString(index++, member.getMbMobile());
            psmt.setTimestamp(index++, Timestamp.valueOf(LocalDateTime.now()));
            return psmt;
        }, keyHolder);

        // ì‚½ì… ì„±ê³µ ì‹œ, ìƒì„±ëœ í‚¤ë¥¼ member ê°ì²´ì— ë°˜ì˜
        if (rows > 0) {
            long mbNo = Objects.requireNonNull(keyHolder.getKey()).longValue();
            log.debug("Inserted member with mbNo={}", mbNo);
            // Reflectionì„ ì‚¬ìš©í•˜ì—¬ member ê°ì²´ì˜ mbNo í•„ë“œë¥¼ ë™ì ìœ¼ë¡œ ì„¤ì •
            ReflectionUtils.setField(member, "mbNo", mbNo);
        }
    }

```

- ì´ê±¸ ë³´ë©´ int rows ë¥¼ ë³´ë©´ ì½”ë“œê°€ ì‚´ì§ ë‹¤ë¥´ë‹¤ ì´ì „ê³¼ ë‹¤ë¥¸ ì ì€jdbcTemplate.update ë¥¼ í†µí•´ì„œ ë„£ì–´ì¤€ë‹¤
- jdbcTemplateì˜ keyHolderê°ì²´ë¥¼ í†µí•´ì„œ ì—…ë°ì´íŠ¸í•  ë•Œ ì•Œì•„ì„œ ì•„ì´ë”” ê°’ì„ ë„£ì–´ì¤€ë‹¤
- if(rows>0)ì—ì„œ ê°€ì ¸ì™€ì„œ ì”€
- jdbcTemplateë¥¼ ì¨ì•¼ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆëŠ”ë° ì—¬ê¸°ì„œ ì´ë ‡ê²Œ í•˜ëŠ” ë°©ë²•ì€
- saveë©”ì†Œë“œ ìœ„ì— @Transactional ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€í•´ì£¼ë©´ ë¨
- ì´ ì™¸ì—ë„ ë‹¤ë¥¸ ë©”ì†Œë“œì— íŠ¸ëœì­ì…˜ ì–´ë…¸í…Œì´ì…˜ì„ ë‹¬ì•„ì¤˜ì•¼í•˜ëŠ”ë° ì´ê±´ ë²ˆê±°ë¡œìš°ë‹ˆê¹Œ Repository ìì²´ì˜ ëª¨ë“  ë©”ì†Œë“œë¥¼ íŠ¸ëœì­ì…˜ ì²˜ë¦¬í•˜ê³  ì‹¶ë‹¤í•˜ë©´ í´ë˜ìŠ¤ ë ˆë²¨ì—ì„œ @Transactionalì„ ë¶™ì´ë©´ ë¨ ì¦‰

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„Œá…¥á†« 11.16.25.png](attachment:79658f75-0715-45ed-9de5-27fe1efc7e94:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„Œá…¥á†«_11.16.25.png)

í•˜ì§€ë§Œ ì˜ˆì œì—ì„œëŠ” ë¶™ì´ì§€ ì•Šì•˜ë‹¤

- Commit, Rollbackì„ ì™œ ì´ Repository ë ˆë²¨ì—ì„œ í•´ì£¼ì§€ ì•Šì•˜ì„ê¹Œ
- íŠ¸ëœì­ì…˜ ì²˜ë¦¬ì‹œ ì—ëŸ¬ ë°œìƒì‹œ ë¡¤ë°±ì´ ë˜ëŠ”ë°
- ë³´í†µ ì—ëŸ¬ ë°œìƒí• ê²Œ repository, service, controller ì¤‘ serviceì—ì„œ ì¢€ ë§ì´ ë°œìƒí•œë‹¤
- ì™œëƒí•˜ë©´ ì—¬ëŸ¬ ë ˆí¬ì§€í† ë¦¬ì— ì ‘ê·¼ì„ í•˜ê²Œ ë˜ëŠ”ë°, ì¦‰ DB ì²˜ë¦¬ëŠ” ì˜ ëì§€ë§Œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆê¸°ì— ë¡¤ë°±ì€ ì„œë¹„ìŠ¤ì—ì„œ ì²˜ë¦¬í•œë‹¤
- ì¦‰ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ì‹œ repostioryê°€ ì•„ë‹Œ serviceì—ì„œ ë¡¤ë°±, ì»¤ë°‹ ë“±ë“±ì„ ì²˜ë¦¬í•˜ëŠ”ê²Œ ë§ë‹¤
- ê°ê° ë ˆí¬ì§€í† ë¦¬ ë‹¨ìœ„ë¡œ íŠ¸ëœì­ì…˜ ê±¸ë©´ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ë‹¨ìœ„ë¡œ ì•ˆ ë¬¶ì¸ë‹¤
- ì¦‰ ì„œë¹„ìŠ¤ë‹¨ì—ì„œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë¥¼ í•œë‹¤

---

# TODO 3

```java
@ContextConfiguration(classes = {ApplicationConfig.class})
@ExtendWith(SpringExtension.class)

```

- @Autowired ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ memberRepositoryë¥¼ í†µí•´ í•„ë“œì— ì£¼ì…
- ì´ê±°í•˜ë ¤ë©´ ApplicationContextì— ë“±ë¡ë˜ì–´ìˆì–´ì•¼í•˜ëŠ”ë° ì´ê±¸ í…ŒìŠ¤íŠ¸í™˜ê²½ì—ì„œë„ ë§Œë“¤ì–´ì£¼ëŠ”ê²Œ SpringExtension.class
- Contextë¥¼ ë§Œë“¤ ë•Œ ì–´ë–¤ í™˜ê²½ì„ ë§Œë“¤ê±°ëƒê°€ @ContextConfiguration

```java
/**
 * TODO#3-1-3 í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œì˜ íŠ¸ëœì­ì…˜ ì²˜ë¦¬
 * @Transactional: ì´ ì–´ë…¸í…Œì´ì…˜ì€ í…ŒìŠ¤íŠ¸ ë©”ì†Œë“œê°€ ì‹¤í–‰ë  ë•Œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³ , ë©”ì†Œë“œ ì‹¤í–‰ í›„ ìë™ìœ¼ë¡œ ë¡¤ë°±ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
 * ì£¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©ë˜ë©°, í…ŒìŠ¤íŠ¸ê°€ ëë‚œ í›„ ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ ì‚¬í•­ì„ ë‚¨ê¸°ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
 */
@Transactional
```

- í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ì•ˆì˜ ê°ê°ì˜ ë©”ì†Œë“œë“¤ì€ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ê°€ ëœë‹¤
- ì¦‰ ì»¤ë°‹, ë¡¤ë°±ì´ ì ìš©ë¨
- í…ŒìŠ¤íŠ¸ì—ì„œëŠ” íŠ¸ëœì­ì…˜ ì²˜ë¦¬ê°€ ë‹¤ ì»¤ë°‹ ë˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ì •ìƒì ìœ¼ë¡œ ë˜ë”ë¼ë„ ë‹¤ ë¡¤ë°±ë¨
    - ì»¤ë°‹ì‹œì¼œë²„ë¦¬ë©´ ë°ì´í„°ë² ì´ìŠ¤ì— ë‹¤ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì—

```java
 /**
     * TODO#3-1-5 Rollback ê´€ë¦¬
     *  - @Rollback(value=true)  =  test method ì‹¤í–‰ í›„ rollback ë©ë‹ˆë‹¤.
     *  - @Rollback(value=false) =  test method ì‹¤í–‰ í›„ rollback ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
     *  - @Rollback ì—ë„ˆí…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šë”ë¼ë„ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” @Transactional ë•Œë¬¸ì— rollback ë©ë‹ˆë‹¤.
     */
    @Rollback(value = true)
    @Test
    @DisplayName("íšŒì›ë“±ë¡")
    void save() {

        Member member1 = Member.ofNewMember("marco@nhnacademy.com","ë§ˆë¥´ì½”","12345","01012345678");
        Member member2 = Member.ofNewMember("test@nhnacademy.com","í…ŒìŠ¤íŠ¸","12345","01011112222");

        memberRepository.save(member1);
        memberRepository.save(member2);

        Optional<Member> actualOptionalMember1 = memberRepository.findByMbNo(member1.getMbNo());
        Optional<Member> actualOptionalMember2 = memberRepository.findByMbNo(member1.getMbNo());

        Assertions.assertTrue(actualOptionalMember1.isPresent());
        Assertions.assertTrue(actualOptionalMember2.isPresent());

        log.debug("member1: {}", actualOptionalMember1.get());
        log.debug("member2: {}", actualOptionalMember2.get());

        Assertions.assertAll(
                ()->Assertions.assertNotNull(actualOptionalMember1.get()),
                ()->Assertions.assertEquals(member1.getMbEmail(), actualOptionalMember1.get().getMbEmail()),
                ()->Assertions.assertEquals(member1.getMbName(), actualOptionalMember1.get().getMbName()),
                ()->Assertions.assertEquals(member1.getMbPassword(), actualOptionalMember1.get().getMbPassword()),
                ()->Assertions.assertEquals(member1.getMbMobile(), actualOptionalMember1.get().getMbMobile()),
                ()->Assertions.assertNotNull(actualOptionalMember1.get().getCreatedAt()),

                ()->Assertions.assertNotNull(actualOptionalMember2.get()),
                ()->Assertions.assertEquals(member1.getMbEmail(), actualOptionalMember2.get().getMbEmail()),
                ()->Assertions.assertEquals(member1.getMbName(), actualOptionalMember2.get().getMbName()),
                ()->Assertions.assertEquals(member1.getMbPassword(), actualOptionalMember2.get().getMbPassword()),
                ()->Assertions.assertEquals(member1.getMbMobile(), actualOptionalMember2.get().getMbMobile()),
                ()->Assertions.assertNotNull(actualOptionalMember2.get().getCreatedAt())
        );

    }
```

- ì‹¤ì œ í…ŒìŠ¤íŠ¸ì½”ë“œë“¤ì€ ê±°ì˜ ë³€í•œê²Œ ì—†ë‹¤

---

# TODO 4

```java
/**
 * TODO#4 Spring ê¸°ë°˜ì˜ Service í™˜ê²½(êµ¬ì„±)
 */
@Slf4j

/**
 * TODO#4-1 @Service
 * ì´ ì–´ë…¸í…Œì´ì…˜ì€ Springì˜ ì„œë¹„ìŠ¤ ê³„ì¸µ(Component)ë¡œ ì‚¬ìš©ë˜ëŠ” í´ë˜ìŠ¤ì— ì ìš©ë©ë‹ˆë‹¤.
 * ì„œë¹„ìŠ¤ ê³„ì¸µì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ì—­í• ì„ í•˜ë©°, @Service ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ Springì´ í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ
 * ë¹ˆ(Bean)ìœ¼ë¡œ ë“±ë¡í•˜ì—¬ ì˜ì¡´ì„± ì£¼ì…ì„ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
 * ì´ ì–´ë…¸í…Œì´ì…˜ì€ ì£¼ë¡œ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ì— ì‚¬ìš©ë˜ë©°, í•´ë‹¹ í´ë˜ìŠ¤ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ì—­í• ì„ ë‹´ë‹¹í•œë‹¤ê³ 
 * Springì—ê²Œ ì•Œë ¤ì¤ë‹ˆë‹¤.
 *
 * @ServiceëŠ” @Componentì˜ íŠ¹ìˆ˜í™”ëœ í˜•íƒœì´ê¸° ë•Œë¬¸ì—, Springì˜ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì— ì˜í•´ ìë™ìœ¼ë¡œ ë¹ˆìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.
 * ë”°ë¼ì„œ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ë‚˜ í´ë˜ìŠ¤ì—ì„œ ì˜ì¡´ì„± ì£¼ì…ì„ í†µí•´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 */
@Service

/**
 * TODO#4-2 @Transactional
 * ì´ ì–´ë…¸í…Œì´ì…˜ì€ ë©”ì†Œë“œ ë˜ëŠ” í´ë˜ìŠ¤ ìˆ˜ì¤€ì— ì ìš©ë˜ì–´ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
 * íŠ¸ëœì­ì…˜ì€ ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì—ì„œ ì—¬ëŸ¬ ì—°ì‚°ì„ í•˜ë‚˜ì˜ ë‹¨ìœ„ë¡œ ë¬¶ì–´, ê·¸ ì—°ì‚°ë“¤ì´ ëª¨ë‘ ì„±ê³µí•˜ê±°ë‚˜ ì‹¤íŒ¨í•´ì•¼ í•˜ëŠ” ì¡°ê±´ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * @Transactionalì€ ì£¼ë¡œ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì‚¬ìš©ë˜ë©°, ë©”ì†Œë“œ ì‹¤í–‰ì´ ëë‚˜ë©´ íŠ¸ëœì­ì…˜ì„ ìë™ìœ¼ë¡œ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•©ë‹ˆë‹¤.
 *
 * ì´ ì–´ë…¸í…Œì´ì…˜ì´ ì ìš©ëœ ë©”ì†Œë“œê°€ ì‹¤í–‰ë˜ë©´ Springì€ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³ , ë©”ì†Œë“œ ì‹¤í–‰ í›„ ìë™ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„
 * ì»¤ë°‹í•©ë‹ˆë‹¤. ë§Œì•½ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´, íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•©ë‹ˆë‹¤. ë¡¤ë°± ì¡°ê±´ì€ ê¸°ë³¸ì ìœ¼ë¡œ `RuntimeException`ê³¼ `Error`ì— ëŒ€í•´ì„œë§Œ ì ìš©ë©ë‹ˆë‹¤.
 * ì˜ˆì™¸ë¥¼ ë‹¤ë£° ë•Œ `@Transactional(rollbackFor = Exception.class)`ì™€ ê°™ì´ ì„¤ì •í•˜ì—¬ ì»¤ìŠ¤í…€ ì˜ˆì™¸ë¥¼ ì§€ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
 * @Transactional
 */
@Transactional
```

- ì˜ë¯¸ìƒ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” ì• ë¼ê³  @Service ë¶™ì—¬ì£¼ê³  ì´ í´ë˜ìŠ¤ ì•ˆì— ëª¨ë“  ë©”ì†Œë“œë“¤ì€ Transaction ì²˜ë¦¬ê°€ ë¨
- ë¹ˆ ì´ë¦„ì€ ìë™ìœ¼ë¡œ ìƒì„±ë¨

```java
@Controller
public class MemberController(){
    private final MemberService memberService;
    public MemberController(MemberService memberService){this.memberService=memberService;}
}

```

ìŠ¤í”„ë§ì€ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´ê°€ 1ê°œë°–ì— ì—†ë‹¤ë©´ ê·¸ ë©¤ë²„ ì„œë¹„ìŠ¤ë¼ëŠ”ê±¸ ì£¼ì…ì‹œí‚¨ë‹¤

ë§Œì•½ memberSerivce ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ê°€ ì—¬ëŸ¬ê°œë¼ë©´ ì–´ë–¤ ì• ë¥¼ ì£¼ì…ì‹œí‚¬ì§€ ëª¨ë¥´ë‹ˆê¹Œ

ê·¸ëŸ´ ë•Œ ì“°ëŠ”ê²Œ Qualifier

```java
public MemberController(@Qualifier("memberServiceImpl") MemberService memberService){this.memberService=memberService;}
```

ì´ë ‡ê²Œ ì¨ì£¼ë©´ memberService êµ¬í˜„ì²´ê°€ ì—¬ëŸ¬ê°œì—¬ë„ ì£¼ì…í• ê²ƒì€ ì´ MemberControllerë¼ëŠ” ê±¸ ë¹ˆì— ì£¼ì…í•œë‹¤ëŠ” ì–˜ê¸°ë‹¤ 

---

## ë³µìŠµ

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„’á…® 1.22.04.png](attachment:96bc6af8-2c27-4272-a539-95afc3594795:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„’á…®_1.22.04.png)

```java
package com.nhnacademy.demo.controller;

import com.nhnacademy.demo.service.MemberService;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
public class MemberController {
    private final MemberService memberService;

    public MemberController(@Qualifier("defaultMemberService") MemberService memberService){
        this.memberService =   memberService;

    }

//    @RequestMapping(method = RequestMethod.GET, value = "/index.do")
    @GetMapping("/index.do")
    public String index(){
        return memberService.getMemberName();
    }

}

```

`@ResponseBody`

- ì´ê±° ì¶”ê°€ì‹œ viewNameìœ¼ë¡œ ë³´ëŠ”ê²Œ ì•„ë‹Œ ë¦¬í„´ë˜ëŠ” ë¬¸ìì—´ ìì²´ë¥¼ ë³´ì—¬ì¤Œ
    
    ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„’á…® 1.23.25.png](attachment:95db9292-bf6f-4ad8-9653-ca6f04b4e358:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„’á…®_1.23.25.png)
    

```java
    public MemberController(@Qualifier("adminMemberService") MemberService memberService){
        this.memberService =   memberService;

    }

```

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„’á…® 1.24.30.png](attachment:318e6598-3f06-4002-978e-c71797d00998:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„’á…®_1.24.30.png)

ì´ë ‡ê²Œ ë°”ë€ŒëŠ”ê±° í™•ì¸

```java
package com.nhnacademy.demo.controller;

import com.nhnacademy.demo.service.MemberService;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller
public class MemberController {
    private final MemberService memberService;

    public MemberController( MemberService memberService){
        this.memberService =   memberService;

    }

//    @RequestMapping(method = RequestMethod.GET, value = "/index.do")

    @GetMapping("/index.do")
    @ResponseBody
    public String index(){
        return memberService.getMemberName();
    }

}

```

ì´ê±° Qualifier ì§€ì •ì•ˆí•˜ê³  ë””í´íŠ¸ë¡œ ë“¤ì–´ê°”ìœ¼ë©´ ì¢‹ê² ì–´ë¼ê³  í•œë‹¤ë©´

@Primary ë¶™ì—¬ì ¸ìˆëŠ” ì• ë¥¼ ìš°ì„  ì£¼ì…

```java
package com.nhnacademy.demo.service.impl;

import com.nhnacademy.demo.repository.MemberRepository;
import com.nhnacademy.demo.service.MemberService;
import org.springframework.context.annotation.Primary;
import org.springframework.stereotype.Service;

@Primary
@Service("defaultMemberService")
public class DefaultMemberSerivce implements MemberService {

    private final MemberRepository memberRepository;

    public DefaultMemberSerivce(MemberRepository memberRepository ){
        this.memberRepository= memberRepository;
    }

    @Override
    public String getMemberName() {
        return "Default";
    }
}

```

---

## **Portable Service Abstraction**

- IoC, DI, PSAëŠ” Spring-Coreì˜ 3ê°€ì§€ í•µì‹¬ ê¸°ìˆ 

```java
@Autowired
    private MemberService memberService;

```

Autowired ë˜ë„ë¡ ì“°ì§€ ì•ŠëŠ” ì´ìœ  

- finalì„ ë¹¼ë©´ ê°ì²´ê°€ ë³€í•  ìˆ˜ ìˆë‹¤.

```java
 @GetMapping("/index.do")
    @ResponseBody
    public String index(){
        memberService = new AdminMemberService();
        return memberService.getMemberName();
    }

```

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„’á…® 1.42.38.png](attachment:f83d602a-6533-4306-8a15-957b24f32af0:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„’á…®_1.42.38.png)

- Primaryê°€ Defaultë¡œ ë˜ì–´ìˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ê°ì²´ë¥¼ Adminìœ¼ë¡œ ì„ ì–¸í•´ì„œ ë³€ê²½ë˜ì–´ ê²°ê³¼ì ã…‡ë¡œ Adminì´ ë‚˜ì˜¤ëŠ” ë¬¸ì œì 
- ê²°ê³¼ì ìœ¼ë¡œ Autowiredë¥¼ ì•ˆì“°ëŠ” ìƒì„±ì ì£¼ì…ì„ ì“°ëŠ”ê²Œ ì¢‹ë‹¤
- ì¦‰ finalì„ ì´ìš©í•´ì„œ ë¶ˆë³€ê°ì²´ë¡œ ì‚¬ìš©í•˜ëŠ”ê²Œ ë°”ëŒì§í•˜ë‹¤

<aside>
ğŸ’¡

ë§Œì•½ ìƒí™©ì— ë”°ë¼ ë¶„ê¸°ë¡œ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ ì¦‰,, Default, Admin ë‘˜ë‹¤ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´?

```java
package com.nhnacademy.demo.controller;

import com.nhnacademy.demo.service.MemberService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import java.util.List;

@Controller
public class MemberController {
    private List<MemberService> memberServiceList;

    public MemberController( List<MemberService> memberServiceList){
        this.memberServiceList =   memberServiceList;

    }
//    @RequestMapping(method = RequestMethod.GET, value = "/index.do")

    @GetMapping("/index.do")
    @ResponseBody
    public String index(){
        return memberServiceList.get(1).getMemberName();
    }

}

```

ì´ë ‡ê²Œ í›„

```java
package com.nhnacademy.demo.service.impl;

import com.nhnacademy.demo.service.MemberService;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Service;

@Service("adminMemberService")
@Order(2)
public class AdminMemberService implements MemberService {

    @Override
    public String getMemberName() {
        return "Admin";
    }
}

```

DefaultëŠ” Order(1)

ì—¬ê¸°ì„œ OrderëŠ” ë¹ˆì´ ìƒì„±ë˜ëŠ” ìˆœì„œë¥¼ ì •ì˜í•œê±´ë° ì´ì™€ ê°™ì´ í•œë‹¤ë©´? ë‹¹ì—°íˆ 0ë²ˆ ìš”ì†Œ ì¶œë ¥ì‹œ **Default**ë¼ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¨ë‹¤

</aside>

## í™˜ê²½ ì„¤ì •ì— ì˜í•´ ë¹ˆì„ ìƒì„±í•˜ëŠ” ë°©ë²•

```java
package com.nhnacademy.demo.controller;

import com.nhnacademy.demo.config.ApplicationConfig;
import com.nhnacademy.demo.service.MemberService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import java.util.List;

@Controller
public class MemberController {
    private List<MemberService> memberServiceList;
    private final String helloMessage;

    public MemberController(String helloMessage){
        this.helloMessage = helloMessage;
    }

    @GetMapping("/index.do")
    @ResponseBody
    public String index(){
//        return memberServiceList.get(0).getMemberName();
        return helloMessage;
    }

}

```

- ë©”ì†Œë“œ ë‹¨ìœ„ ë¹ˆ ë“±ë¡ @Bean
    
    ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„’á…® 2.00.29.png](attachment:582447ca-7f6e-4603-ad40-5cd729a20a82:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„’á…®_2.00.29.png)
    

ìš°ì„ 

**db.properties**

```java
db.username=test
db.password=1234
```

ì´ê±¸ DbProperties

```java
package com.nhnacademy.demo.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.PropertySource;

@Configuration
@PropertySource("classpath:db.properties")
public class DbProperties {
    private String userName;
    private String userPassword;

    public String getUserName(){
        return userName;
    }

    public String getUserPassword(){
        return  userPassword;
    }
}

```

ì´ì œ ê°ê°ì˜ í•„ë“œì— í”„ë¡œí¼í‹°ê°’ í• ë‹¹í•´ì£¼ëŠ”ê±°

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„’á…® 2.07.23.png](attachment:f4da6d9d-0fd4-47fc-abe1-22b018cd3167:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„’á…®_2.07.23.png)

- ìŠ¤í”„ë§í”„ë ˆì„ì›Œí¬ì˜ ë°¸ë¥˜ì¸ ê²ƒì„ ê¼­ í™•ì¸ !!

```java
package com.nhnacademy.demo.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.PropertySource;

@Configuration
@PropertySource("classpath:db.properties")
public class DbProperties {
    @Value("${db.username}")
    private String userName;
    @Value("${db.password}")
    private String userPassword;

    public String getUserName(){
        return userName;
    }

    public String getUserPassword(){
        return  userPassword;
    }
}

```

ì´ì œ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì ìš© í›„ í…ŒìŠ¤íŠ¸

```java

package com.nhnacademy.demo.controller;

import com.nhnacademy.demo.config.ApplicationConfig;
import com.nhnacademy.demo.config.DbProperties;
import com.nhnacademy.demo.service.MemberService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import java.util.List;

@Controller
public class MemberController {
    private List<MemberService> memberServiceList;
    private final String helloMessage;
    private final DbProperties dbProperties;

    public MemberController(String helloMessage, DbProperties dbProperties){
        this.helloMessage = helloMessage;
        this.dbProperties = dbProperties;
    }

    @GetMapping("/index.do")
    @ResponseBody
    public String index(){
//        return memberServiceList.get(0).getMemberName();
        return dbProperties.toString();
    }

}

```

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„’á…® 2.10.29.png](attachment:6602dca7-6e75-4a81-8295-983f1c4d3926:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„’á…®_2.10.29.png)

![image.png](attachment:d6f02238-7369-407a-8295-1de2ded61ae4:image.png)

í…ŒìŠ¤íŠ¸ ì½”ë“œ ìƒì„± 

```java
@ExtendWith(SpringExtension.class)
```

```java
package com.nhnacademy.demo.service.impl;

import com.nhnacademy.demo.repository.MemberRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.junit.jupiter.api.Assertions.*;

@ExtendWith(MockitoExtension.class)
class DefaultMemberSerivceTest {

//    @Mock  //ê°€ì§œ ê°ì²´ ì£¼ì…
    MemberRepository memberRepository;

//    @InjectMocks
    DefaultMemberSerivce defaultMemberSerivce;

    void setUp(){
        memberRepository = Mockito.mock(MemberRepository.class); // ê°€ì§œ ê°ì²´ê°€ ë¨
        defaultMemberSerivce = new DefaultMemberSerivce(memberRepository);
    }

    @Test
    void getMemberName() {
    }
}
```

ì›ë˜ëŒ€ë¡œë¼ë©´ ì´ë ‡ê²Œ í•´ì¤¬ëŠ”ë° 

```java
package com.nhnacademy.demo.service.impl;

import com.nhnacademy.demo.repository.MemberRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.junit.jupiter.api.Assertions.*;

@ExtendWith(MockitoExtension.class)
class DefaultMemberSerivceTest {

    @Mock  //ê°€ì§œ ê°ì²´ ì£¼ì…
    MemberRepository memberRepository;

    @InjectMocks
    DefaultMemberSerivce defaultMemberSerivce;
    
    
    
        
    @Test
    void getMemberName() {
    }
}
```

ì´ë ‡ê²Œ ê°„í¸í•˜ê²Œ ê°€ëŠ¥ 

!!!

---

# JPA

## Spring Data

- Spring DataëŠ” Spring ìƒíƒœê³„ì˜ ì¼ë¶€ë¡œ, ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì„ ì‰½ê²Œ êµ¬ì„±í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ìƒí˜¸ì‘ìš©ì„ ê°„í¸í•˜ê²Œ í•˜ê¸° ìœ„í•´ ì œê³µë˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.
- ì´ë¥¼ í†µí•´ ê°œë°œìëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì„ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìœ¼ë©°,Â `ë‹¤ì–‘í•œ ë°ì´í„° ì €ì¥ì†Œì—`Â ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- Spring Dataì˜ ì£¼ìš” ëª©í‘œëŠ” ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì„ ë‹¨ìˆœí™”í•˜ê³ ,Â `ì¼ê´€ëœ í”„ë¡œê·¸ë˜ë° ëª¨ë¸ì„`Â ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
- ì¦‰, SpringÂ `DataëŠ” ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì„ ë‹¨ìˆœí™”í•˜ê³  ë‹¤ì–‘í•œ ë°ì´í„° ì €ì¥ì†Œì™€ì˜ ìƒí˜¸ì‘ìš©ì„`Â ì§€ì›í•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

**Spring Data JPA**

- JPA(Java Persistence API)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ ê´€ê³„ ë§¤í•‘(ORM) ë° ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì„ êµ¬í˜„í•©ë‹ˆë‹¤.
- Repository ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ CRUD ì‘ì—…ì„ ì‰½ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ê±°ë§Œ ì œëŒ€ë¡œ ì¨ë„ MongoDB, Redis, ë“±.. ë­ë“  ì“¸ ìˆ˜ ìˆë‹¤

<aside>
ğŸ’¡

**PSA**

**ì´ë”° ì°¾ì•„ì„œ ì •ë¦¬í•˜ê¸°**

</aside>

ì§ì ‘ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¥¼ ì“°ê¸°ë³´ë‹¨ , ì—”í‹°í‹° ê°ì²´ì˜ ì—°ê´€ê´€ê³„ë¥¼ ì´ìš©í•´ ì¿¼ë¦¬ë“¤ì´ ìë™ìœ¼ë¡œ ìƒì„±ë  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê²ƒì´ **Object Relation Mapping**ì´ë¼ê³  í•œë‹¤

- **ì´ ORM ìŠ¤í™ì„ ë§Œë“¤ì–´ë‘” ê²ƒì´ JPA**

[[DB] í•˜ì´ë²„ë„¤ì´íŠ¸(Hibernate)ë€?](https://livenow14.tistory.com/70)

ê²°ë¡  : Spring Data JPAëŠ” í•˜ì´ë²„ë„¤ì´íŠ¸ë¥¼ ì¢€ ë” ì¶”ìƒí™”í•œ ê±°ê³  ORMì„ êµ¬í˜„í–ˆë‹¤? 

í•˜ì´ë²„ë„¤ì´íŠ¸ ì˜¤í”ˆ ì†ŒìŠ¤ì§€ë§Œ ORMì´ í‘œì¤€

ê°ì²´ë“¤ê°„ì˜ ì—°ê´€ê´€ê³„ë¥¼ ì´ìš©í•´ì„œ ì¿¼ë¦¬ ì‘ì„± ì—†ì´ë„ ë°ì´í„° ì¡°íšŒê°€ ê°€ëŠ¥í•œ

### Entity

- ê°ì²´
- ORMì˜ ê°ì²´ = ì—”í‹°í‹°
- í…Œì´ë¸”ê³¼ ê°ì²´ë¡œ 1:1ë¡œ ë§¤í•‘ë¨

```java
í´ë˜ìŠ¤ëŠ” ë‹¨ìˆ˜ í…Œì´ë¸”ì€ ë³µìˆ˜í˜•ìœ¼ë¡œ 
//@Entity anootationì„ ì„ ì–¸í•˜ì„¸ìš”.
@Entity
//@Table annotationì„ ì‚¬ìš©í•˜ì—¬ TableNameì„ ì§€ì •í•©ë‹ˆë‹¤.
@Table(name = "members")
public class Member {

    //@Id annotationì„ ì‚¬ìš©í•˜ì—¬ entityë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ID Fieldë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
    //íšŒì›_ë²ˆí˜¸
    @Id

    //@GeneratedValue ë¥¼ ì‚¬ìš©í•˜ì—¬ IDìƒì„± ì „ëµì„ ì„¤ì • í•©ë‹ˆë‹¤.
    @GeneratedValue(strategy = GenerationType.IDENTITY) //IDENTITY = AUTO_INCREAMENT
    @Column(name = "mb_no") // ì´ í…Œì´ë¸”ì˜ ê¸°ë³¸í‚¤ ë°˜ë“œì‹œ ìˆì–´ì•¼í•¨ !! 
    private Long mbNo;
```

- JPAì—ì„œ prePersist()ë¥¼ ì´ìš©í•´ ê°ì²´ê°€ ì˜ì†í™”ê°€ ë  ë•Œ createdAtì„ ì„¤ì •í•´ì¤˜ ë“±..  JPAëŠ” ì—”í‹°í‹°ì˜ ìƒì„± ì‹œì  ê²°ì • ê°€ëŠ¥

- ì´ëŸ°ê±¸ EntityManagerê°€ ê´€ë¦¬í•´ì£¼ëŠ”ë°

ìë°”ì—ì„œ ë¡œì»¬í™˜ê²½ í…ŒìŠ¤íŠ¸ ì‹œì—”

![image.png](attachment:ed986de5-fd0c-408c-a9dc-5eb3deade111:image.png)

ì´ì™€ ê°™ì´ h2ë¥¼ ì‚¬ìš©

ì•„ì£¼ ê²½ëŸ‰í™”ëœ DBë¥¼ êµ¬ë™ì‹œì¼œì„œ H2ë¥¼ ì´ìš©

```java

//@PropertySource("classpath:db.properties") // db.properties íŒŒì¼ì„ ë¡œë“œ
ì´ëŸ° ë°©ì‹ìœ¼ë¡œ í•´ì„œëŠ” ì•ˆëœë‹¤ 
```

```java
@SuppressWarnings("java:S107")
@Configuration
@Slf4j
/**
 * TODO#4 - profileì— ë”°ë¼ì„œ í™˜ê²½ì„ ë¡œë“œ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ @PropertySourceëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
//@PropertySource("classpath:db.properties") // db.properties íŒŒì¼ì„ ë¡œë“œ
public class DbProperties {

    // ê¸°ë³¸ Bean ì´ë¦„ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    public static final String BEAN_NAME = "dbProperties";

    @Value("${db.url}")
    private String url; // ë°ì´í„°ë² ì´ìŠ¤ URL
    @Value("${db.username}")
    private String username; // ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ìëª…
    @Value("${db.password}")
    private String password; // ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸
    @Value("${db.initialSize}")
    private int initialSize; // ì´ˆê¸° ì»¤ë„¥ì…˜ í’€ í¬ê¸°
    @Value("${db.maxTotal}")
    private int maxTotal; // ìµœëŒ€ ì»¤ë„¥ì…˜ í’€ í¬ê¸°
    @Value("${db.maxIdle}")
    private int maxIdle; // ìµœëŒ€ ìœ íœ´ ì»¤ë„¥ì…˜ ìˆ˜
    @Value("${db.minIdle}")
    private int minIdle; // ìµœì†Œ ìœ íœ´ ì»¤ë„¥ì…˜ ìˆ˜
    @Value("${db.maxWait}")
    private int maxWait; // ì»¤ë„¥ì…˜ ëŒ€ê¸° ì‹œê°„
    @Value("${db.validationQuery}")
    private String validationQuery; // ì»¤ë„¥ì…˜ ê²€ì¦ ì¿¼ë¦¬
    @Value("${db.testOnBorrow}")
    private boolean testOnBorrow; // ì»¤ë„¥ì…˜ í’€ì—ì„œ ì»¤ë„¥ì…˜ì„ ë¹Œë¦´ ë•Œ ê²€ì¦ ì—¬ë¶€
    @Value("${db.spy}")
    private boolean spy; // P6Spy ë¡œê¹… ì‚¬ìš© ì—¬ë¶€
    //TODO#3 - diriverClassName ë°”ì¸ë”©
    @Value("${db.driverClassName}")
    private String driverClassName;

```

- ì—¬ê¸°ì„œ ì¤‘ê°„ì— ì„ íƒì ìœ¼ë¡œ ì½ì–´ì£¼ëŠ” ë…€ì„ì´ í•„ìš”í•¨

## PropertyConfig

```java

package com.nhnacademy.blog.common.db;

import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.support.PropertySourcesPlaceholderConfigurer;
import org.springframework.core.env.Environment;
import org.springframework.core.io.ClassPathResource;

import java.util.Arrays;

@Slf4j
@Configuration
@SuppressWarnings("squid:S1118")
public class PropertyConfig {

    /** TODO#5 - spring.profiles.active=test ê¸°ë³¸ì„¤ì •
     * - spring.profiles.activeëŠ” Spring í”„ë ˆì„ì›Œí¬ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í™œì„±í™”ëœ í”„ë¡œíŒŒì¼ì„ ì„¤ì •í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì†ì„±ì…ë‹ˆë‹¤.
     * ì´ ì†ì„±ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë  ë•Œ ì–´ë–¤ í”„ë¡œíŒŒì¼ì„ ì‚¬ìš©í• ì§€ë¥¼ ì§€ì •í•˜ë©°, ì´ë¥¼ í†µí•´ ë‹¤ì–‘í•œ í™˜ê²½(ì˜ˆ: ê°œë°œ, í…ŒìŠ¤íŠ¸, í”„ë¡œë•ì…˜)ë³„ë¡œ ë‹¤ë¥¸ ì„¤ì •ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     *
     *  - PropertySourcesPlaceholderConfigurerëŠ” Spring í”„ë ˆì„ì›Œí¬ì—ì„œ í”„ë¡œí¼í‹° íŒŒì¼ì„ ë¡œë“œí•˜ê³ ,
     * ì´ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©ë˜ëŠ” í”„ë¡œí¼í‹° í”Œë ˆì´ìŠ¤í™€ë” ê°’ì„ ëŒ€ì²´í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë¹ˆì…ë‹ˆë‹¤.
     * ì£¼ë¡œ @PropertySource ì• ë…¸í…Œì´ì…˜ê³¼ í•¨ê»˜ ì‚¬ìš©ë˜ì–´ ì™¸ë¶€ í”„ë¡œí¼í‹° íŒŒì¼ì˜ ê°’ì„ Spring ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ì— ì£¼ì…í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
     *
     * @param environment Springì˜ Environment ê°ì²´ë¡œ í™œì„±í™”ëœ í”„ë¡œíŒŒì¼ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
     * @return PropertySourcesPlaceholderConfigurer ê°ì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    @Bean
    public static PropertySourcesPlaceholderConfigurer testProperties(Environment environment) {
        // í™œì„±í™”ëœ í”„ë¡œíŒŒì¼ ì •ë³´ ë¡œê·¸ ì¶œë ¥
        log.debug("profiles:{}", Arrays.stream(environment.getActiveProfiles()).toList());

        PropertySourcesPlaceholderConfigurer configurer = new PropertySourcesPlaceholderConfigurer();
        String property;

        // í™œì„±í™”ëœ í”„ë¡œíŒŒì¼ì— ë”°ë¼ ë¡œë“œí•  í”„ë¡œí¼í‹° íŒŒì¼ ê²°ì •
        if(Arrays.stream(environment.getActiveProfiles()).toList().contains("test")){
            property = "application-test.properties";
        } else if(Arrays.stream(environment.getActiveProfiles()).toList().contains("prod")){
            property = "application-prod.properties";
        } else {
            property = "application-test.properties";  // ê¸°ë³¸ê°’ ì„¤ì •
        }

        // ì„ íƒëœ í”„ë¡œí¼í‹° íŒŒì¼ ì„¤ì •
        configurer.setLocation(new ClassPathResource(property));

        return configurer;
    }
}
```

- í™œì„±í™”ëœ í”„ë¡œíŒŒì¼ì— ë”°ë¼ ë¡œë“œí•  í”„ë¡œí¼í‹° íŒŒì¼ ê²°ì •í•˜ëŠ” ë¶€ë¶„ !!
- 
    
    ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-02-18 á„‹á…©á„’á…® 3.19.26.png](attachment:33e91363-c975-4b8b-a686-e525ef7544e9:á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º_2025-02-18_á„‹á…©á„’á…®_3.19.26.png)
    

![image.png](attachment:d5b3d7c2-3958-4af4-8461-ba49c4ed0bed:image.png)

- ìš´ì˜í™˜ê²½ì—ì„œëŠ” ì¿¼ë¦¬ë¡œê·¸ë¥¼ ë³¼ í•„ìš”ê°€ ì—†ìŒ ê·¸ë¦¬ê³  ì„±ëŠ¥ì—ë„ ì˜í–¥ì„ ë¯¸ì¹˜ë¯€ë¡œ
- prodì—ì„œëŠ” spy = false
- testì—ì„œëŠ” spy = true

```java
    /**
     * TODO#10-1  test(í…ŒìŠ¤íŠ¸) í™˜ê²½ì—ì„œì˜ jpaPropertyMap
     *  - test(í…ŒìŠ¤íŠ¸) í™˜ê²½ì—ì„œì˜ jpaì„¤ì •
     *  - @Profile("test") <-- test profileì—ì„œë§Œ Bean ìƒì„±ë¨.
     * @return
     */
    @Bean("jpaPropertyMap")
    @Profile("test")
    public Map<String, String> testJpaPropertyMap() {
        Map<String, String> map = new HashMap<>();

        // Hibernateê°€ ì‚¬ìš©í•  ë°©ì–¸(dialect)ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” H2 ë°ì´í„°ë² ì´ìŠ¤ ë°©ì–¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        map.put("hibernate.dialect", "org.hibernate.dialect.H2Dialect");

        // Hibernateê°€ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'create-drop'ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•˜ê³ , ì¢…ë£Œ ì‹œ ì‚­ì œí•©ë‹ˆë‹¤.
        map.put("hibernate.hbm2ddl.auto", "create-drop");

        // SQL ì¿¼ë¦¬ë¥¼ ë¡œê·¸ì— ì¶œë ¥í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'true'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ê°€ ë¡œê·¸ì— ì¶œë ¥ë©ë‹ˆë‹¤.
        map.put("hibernate.show_sql", "true");

        // SQL ì¿¼ë¦¬ë¥¼ í¬ë§·í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'true'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ê°€ í¬ë§·ë˜ì–´ ì½ê¸° ì‰½ê²Œ ì •ë ¬ë©ë‹ˆë‹¤.
        map.put("hibernate.format_sql", "true");

        // SQL ì¿¼ë¦¬ì— ì£¼ì„ì„ ì¶”ê°€í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'true'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ì— ì£¼ì„ì´ ì¶”ê°€ë©ë‹ˆë‹¤.
        map.put("hibernate.use_sql_comments", "true");

        return map;
    }

    /**
     * TODO#10-2  prod(ìš´ì˜) í™˜ê²½ì—ì„œì˜ jpaPropertyMap
     *  - prod(ìš´ì˜) í™˜ê²½ì—ì„œì˜ jpaì„¤ì •
     *  - @Profile("prod") <-- prod profileì—ì„œë§Œ Bean ìƒì„±ë¨.
     * @return
     */
    @Bean("jpaPropertyMap")
    @Profile("prod")
    public Map<String, String> prodJpaPropertyMap() {
        Map<String, String> map = new HashMap<>();

        // Hibernateê°€ ì‚¬ìš©í•  ë°©ì–¸(dialect)ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” MySQL ë°ì´í„°ë² ì´ìŠ¤ ë°©ì–¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        map.put("hibernate.dialect", "org.hibernate.dialect.MySQLDialect");

        // Hibernateê°€ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'validate'ëŠ” ì—”í‹°í‹°ì™€ í…Œì´ë¸” êµ¬ì¡°ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì§€ë§Œ, ì‹¤ì œë¡œ ë³€ê²½í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.
        map.put("hibernate.hbm2ddl.auto", "validate");

        // SQL ì¿¼ë¦¬ë¥¼ ë¡œê·¸ì— ì¶œë ¥í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'false'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ê°€ ë¡œê·¸ì— ì¶œë ¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        map.put("hibernate.show_sql", "false");

        // SQL ì¿¼ë¦¬ë¥¼ í¬ë§·í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'false'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ê°€ í¬ë§·ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        map.put("hibernate.format_sql", "false");

        // SQL ì¿¼ë¦¬ì— ì£¼ì„ì„ ì¶”ê°€í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'false'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ì— ì£¼ì„ì´ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        map.put("hibernate.use_sql_comments", "false");
        return map;
    }

```

- @Profileì„ ë³´ë©´ í™˜ê²½ì— ë”°ë¼ì„œ ë¹ˆì´ ìƒì„±ë ìˆ˜ë„ ìˆê³  ì•ˆë ìˆ˜ë„ ìˆë‹¤

```java
package com.nhnacademy.blog.common.config;

import jakarta.persistence.EntityManagerFactory;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import javax.sql.DataSource;
import java.util.HashMap;
import java.util.Map;

@Slf4j
@Configuration

/**
 * TODO#9 - @EnableJpaRepositories ì• ë…¸í…Œì´ì…˜ì€ Spring Data JPA ë¦¬í¬ì§€í† ë¦¬ë¥¼ í™œì„±í™”í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
 * ì´ ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ JPA ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤()ê°€ Spring ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ì— ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.
 */
@EnableJpaRepositories(
        // basePackageClasses ì†ì„±ì€ ìŠ¤ìº”í•  ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ê°€ í¬í•¨ëœ íŒ¨í‚¤ì§€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
        // com.nhnacademy.blog.RootPackageBase í´ë˜ìŠ¤ê°€ ìœ„ì¹˜í•œ íŒ¨í‚¤ì§€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        basePackageClasses = {com.nhnacademy.blog.RootPackageBase.class},
        // transactionManagerRef ì†ì„±ì€ ì‚¬ìš©í•  íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ë¹ˆì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” "jpaTransactionManager"ë¼ëŠ” ì´ë¦„ì˜ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        transactionManagerRef ="jpaTransactionManager",
        // entityManagerFactoryRef ì†ì„±ì€ ì‚¬ìš©í•  ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ ë¹ˆì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” "jpaEntityManagerFactory"ë¼ëŠ” ì´ë¦„ì˜ ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        entityManagerFactoryRef = "jpaEntityManagerFactory"
)

//Springì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê¸°ëŠ¥ì„ í™œì„±í™”í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë©”ì„œë“œì—ì„œ íŠ¸ëœì­ì…˜ì„ ì„ ì–¸ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
@EnableTransactionManagement
public class JpaConfig {

    /**
     * TODO#10 - LocalContainerEntityManagerFactoryBeanì„ ì„¤ì •í•©ë‹ˆë‹¤.
     * ì´ ë©”ì„œë“œëŠ” ë°ì´í„° ì†ŒìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     * @param dataSource , Application Contextì— ë“±ë¡ëœ  dataSource Bean ì£¼ì…ë©ë‹ˆë‹¤.
     * @return
     */
    @Bean(name = "jpaEntityManagerFactory")
    public LocalContainerEntityManagerFactoryBean jpaEntityManagerFactory(DataSource dataSource, Map<String,String> jpaPropertyMap) {
        log.debug("configJpaPropertyMap:{}", jpaPropertyMap);

        LocalContainerEntityManagerFactoryBean factoryBean = new LocalContainerEntityManagerFactoryBean();
        factoryBean.setDataSource(dataSource);
        factoryBean.setPackagesToScan("com.nhnacademy.blog");  // ì—”í‹°í‹° í´ë˜ìŠ¤ê°€ ìœ„ì¹˜í•œ íŒ¨í‚¤ì§€ ì„¤ì •

        // Hibernate ê´€ë ¨ ì„¤ì •
        factoryBean.setJpaPropertyMap(jpaPropertyMap);
        factoryBean.setJpaVendorAdapter(new HibernateJpaVendorAdapter());
        factoryBean.setPersistenceProviderClass(org.hibernate.jpa.HibernatePersistenceProvider.class);

        return factoryBean;
    }

    /**
     * TODO#10-1  test(í…ŒìŠ¤íŠ¸) í™˜ê²½ì—ì„œì˜ jpaPropertyMap
     *  - test(í…ŒìŠ¤íŠ¸) í™˜ê²½ì—ì„œì˜ jpaì„¤ì •
     *  - @Profile("test") <-- test profileì—ì„œë§Œ Bean ìƒì„±ë¨.
     * @return
     */
    @Bean("jpaPropertyMap")
    @Profile("test")
    public Map<String, String> testJpaPropertyMap() {
        Map<String, String> map = new HashMap<>();

        // Hibernateê°€ ì‚¬ìš©í•  ë°©ì–¸(dialect)ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” H2 ë°ì´í„°ë² ì´ìŠ¤ ë°©ì–¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        map.put("hibernate.dialect", "org.hibernate.dialect.H2Dialect");

        // Hibernateê°€ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'create-drop'ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•˜ê³ , ì¢…ë£Œ ì‹œ ì‚­ì œí•©ë‹ˆë‹¤.
        map.put("hibernate.hbm2ddl.auto", "create-drop");

        // SQL ì¿¼ë¦¬ë¥¼ ë¡œê·¸ì— ì¶œë ¥í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'true'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ê°€ ë¡œê·¸ì— ì¶œë ¥ë©ë‹ˆë‹¤.
        map.put("hibernate.show_sql", "true");

        // SQL ì¿¼ë¦¬ë¥¼ í¬ë§·í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'true'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ê°€ í¬ë§·ë˜ì–´ ì½ê¸° ì‰½ê²Œ ì •ë ¬ë©ë‹ˆë‹¤.
        map.put("hibernate.format_sql", "true");

        // SQL ì¿¼ë¦¬ì— ì£¼ì„ì„ ì¶”ê°€í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'true'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ì— ì£¼ì„ì´ ì¶”ê°€ë©ë‹ˆë‹¤.
        map.put("hibernate.use_sql_comments", "true");

        return map;
    }

    /**
     * TODO#10-2  prod(ìš´ì˜) í™˜ê²½ì—ì„œì˜ jpaPropertyMap
     *  - prod(ìš´ì˜) í™˜ê²½ì—ì„œì˜ jpaì„¤ì •
     *  - @Profile("prod") <-- prod profileì—ì„œë§Œ Bean ìƒì„±ë¨.
     * @return
     */
    @Bean("jpaPropertyMap")
    @Profile("prod")
    public Map<String, String> prodJpaPropertyMap() {
        Map<String, String> map = new HashMap<>();

        // Hibernateê°€ ì‚¬ìš©í•  ë°©ì–¸(dialect)ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” MySQL ë°ì´í„°ë² ì´ìŠ¤ ë°©ì–¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        map.put("hibernate.dialect", "org.hibernate.dialect.MySQLDialect");

        // Hibernateê°€ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'validate'ëŠ” ì—”í‹°í‹°ì™€ í…Œì´ë¸” êµ¬ì¡°ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì§€ë§Œ, ì‹¤ì œë¡œ ë³€ê²½í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.
        map.put("hibernate.hbm2ddl.auto", "validate");

        // SQL ì¿¼ë¦¬ë¥¼ ë¡œê·¸ì— ì¶œë ¥í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'false'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ê°€ ë¡œê·¸ì— ì¶œë ¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        map.put("hibernate.show_sql", "false");

        // SQL ì¿¼ë¦¬ë¥¼ í¬ë§·í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'false'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ê°€ í¬ë§·ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        map.put("hibernate.format_sql", "false");

        // SQL ì¿¼ë¦¬ì— ì£¼ì„ì„ ì¶”ê°€í• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // 'false'ë¡œ ì„¤ì •í•˜ë©´ SQL ì¿¼ë¦¬ì— ì£¼ì„ì´ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        map.put("hibernate.use_sql_comments", "false");
        return map;
    }

    /**
     * TODO#11 - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ì„¤ì •
     * - jdbc : DataSourceTransactionManager
     * - jpa : JpaTransactionManager
     * @param entityManagerFactory
     * @return
     */
    @Bean
    public PlatformTransactionManager jpaTransactionManager(EntityManagerFactory entityManagerFactory) {
        return new JpaTransactionManager(entityManagerFactory);
    }
}

```

JPA íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €

PSAêµ¬ì¡° 

```java
package com.nhnacademy.blog.common.context;

import com.nhnacademy.blog.common.config.ApplicationConfig;
import com.nhnacademy.blog.common.db.DbProperties;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.core.env.Environment;
import org.springframework.core.env.PropertySource;
import org.springframework.core.env.StandardEnvironment;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit.jupiter.SpringExtension;

import javax.sql.DataSource;
import java.util.Arrays;
import java.util.Map;

/**
 * TODO#12 - @ActiveProfiles, prodí™˜ê²½ - application-prod.properties í™˜ê²½ êµ¬ì„±
 * Spring í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ì—ì„œ íŠ¹ì • í”„ë¡œíŒŒì¼ì„ í™œì„±í™”í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ì´ ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ íŠ¹ì • í”„ë¡œíŒŒì¼ì„ í™œì„±í™”í•˜ì—¬ í•´ë‹¹ í”„ë¡œíŒŒì¼ì˜ ì„¤ì •ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 * ì´ëŠ” ê°œë°œ, í…ŒìŠ¤íŠ¸, í”„ë¡œë•ì…˜ ë“±ì˜ í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ ì„¤ì •ì„ í…ŒìŠ¤íŠ¸í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
 */
@ActiveProfiles("prod")
@ExtendWith({SpringExtension.class})
@ContextConfiguration(classes = ApplicationConfig.class)
@Slf4j
class ContextHolderProdProfileTest {

    /**
     * TODO#13 - applicationContext ì£¼ì…
     */
    @Autowired
    ApplicationContext applicationContext;

    /**
     * TODO#14 - environment ì£¼ì…
     */
    @Autowired
    Environment environment;

    @Test
    @DisplayName("load context")
    void getApplicationContext(){

        //TODO#15 - prod  context Test

        DbProperties dbProperties = (DbProperties) applicationContext.getBean("dbProperties");
        log.debug("dbProperties:{}", dbProperties);

        DataSource dataSource = (DataSource) applicationContext.getBean("dataSource");
        log.debug("dataSource:{}", dataSource);

        Assertions.assertNotNull(dbProperties);
        Assertions.assertNotNull(dataSource);

        Assertions.assertAll(
                ()->Assertions.assertTrue(dbProperties.getUrl().contains("jdbc:mysql")),
                ()->Assertions.assertTrue(dbProperties.getUsername().contains("nhn_academy_")),
                ()->Assertions.assertEquals(5, dbProperties.getInitialSize()),
                ()->Assertions.assertEquals(5, dbProperties.getMaxTotal()),
                ()->Assertions.assertEquals(5, dbProperties.getMaxIdle()),
                ()->Assertions.assertEquals(5, dbProperties.getMinIdle()),
                ()->Assertions.assertEquals(2, dbProperties.getMaxWait()),
                ()->Assertions.assertEquals("com.mysql.cj.jdbc.Driver", dbProperties.getDriverClassName()),
                ()->Assertions.assertEquals("select 1", dbProperties.getValidationQuery()),
                ()->Assertions.assertTrue(dbProperties.isTestOnBorrow())
        );
    }

    @Test
    @DisplayName("profile : prod")
    void profileTest(){
        //TODO#16 - active prod profile
        boolean actual = Arrays.stream(environment.getActiveProfiles()).toList().contains("prod");
        Assertions.assertTrue(actual);
    }

    /**
     * Springì˜ Environment ê°ì²´ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì£¼ìš” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
     * - í”„ë¡œíŒŒì¼ ê´€ë¦¬: í™œì„±í™”ëœ í”„ë¡œíŒŒì¼ì„ ê´€ë¦¬í•˜ê³ , í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ ì„¤ì •ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•©ë‹ˆë‹¤.
     * - í™˜ê²½ ë³€ìˆ˜ ë° ì‹œìŠ¤í…œ í”„ë¡œí¼í‹° ì ‘ê·¼: ìš´ì˜ì²´ì œì˜ í™˜ê²½ ë³€ìˆ˜ì™€ Java ì‹œìŠ¤í…œ í”„ë¡œí¼í‹°ì— ì ‘ê·¼í•˜ì—¬ ë™ì ìœ¼ë¡œ ì„¤ì •ì„ ì¡°ì •í•©ë‹ˆë‹¤.
     * - í”„ë¡œí¼í‹° ì†ŒìŠ¤ ê´€ë¦¬: ì—¬ëŸ¬ í”„ë¡œí¼í‹° ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•˜ì—¬ ì„¤ì • ì •ë³´ë¥¼ ì¤‘ì•™í™”í•˜ê³ , í•„ìš”ì— ë”°ë¼ ì½ì–´ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     * = í”„ë¡œí¼í‹° ê°’ ë³€í™˜: í”„ë¡œí¼í‹° ê°’ì„ ë‹¤ì–‘í•œ íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
     * ì¦‰ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ë“¤ì„ Environmentë¥¼ í†µí•´ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.
     */
    @Test
    @DisplayName("environment test")
    void environmentTest(){
        //TODO#17 - ì‹œìŠ¤í…œ í™˜ê²½ë³€ìˆ˜ ì¶œë ¥
        for (PropertySource<?> propertySource : ((StandardEnvironment) environment).getPropertySources()) {
            if (propertySource.getSource() instanceof java.util.Map) {
                @SuppressWarnings("unchecked")
                Map<String, Object> map = (Map<String, Object>) propertySource.getSource();
                map.forEach((key, value) -> log.debug("key:{}= value:{}", key, value));
            }
        }
    }

}
```

- ì´ê±¸ ë³´ë©´ ì„ íƒì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„± ê°€ëŠ¥
- @ActiveProfiles
- 

ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€  ìƒì„±ë˜ëŠ” ì‹œì : íŠ¸ëœì­ì…˜ì´ ì‹œì‘í•  ë•Œ  (@Transactional)

ê·¸ ì‹œì ì— ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ ë¹ˆì— ì˜í•´ ì—”í‹°í‹°ë§¤ë‹ˆì €ê°€ ìƒì„±ë¨

íŠ¸ëœì­ì…˜ ì–´ë…¸í…Œì´ì…˜ì„ ë ˆí¬ì§€í† ë¦¬ê°€ ì•„ë‹Œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆëŠ” ì„œë¹„ìŠ¤ì— ë¶™ì¸ë‹¤ëŠ” ì 

ë ˆí¬ì§€í† ë¦¬ í•˜ë‚˜ ì˜¤ë¥˜ë‚˜ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì „ì²´ ë¡¤ë°±í•´ì•¼í•˜ë‹ˆ

ì˜ì†ì„± ì„œë¹„ìŠ¤ì˜ 4ê°€ì§€ íŠ¹ì§• 

- **ë°ì´í„°ë¥¼ ìƒì„±í•œ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë˜ì–´ë„ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ” ë°ì´í„°ì˜ íŠ¹ì„±**

[[JPA/ê¹€ì˜í•œ] ì˜ì†ì„±ì´ë€ ë¬´ì—‡ì¼ê¹Œ?](https://velog.io/@sooyoungh/%EC%98%81%EC%86%8D%EC%84%B1%EC%9D%B4%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C)
